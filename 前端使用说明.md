# Animal API 前端使用说明

## 基础配置

### API 基础地址
```
http://localhost:3000/api
```

### 公开接口（无需token）
- `POST /api/register` - 用户注册
- `POST /api/login` - 用户登录

### 需要token的接口
所有其他接口都需要在请求头中添加 `Authorization: Bearer <token>`

---

## 用户认证

### 1. 用户注册

**接口**：`POST /api/register`

**请求示例**：
```javascript
// JavaScript Fetch API
fetch('http://localhost:3000/api/register', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    name: '张三',
    account: 'zhangsan',
    password: '123456'
  })
})
.then(response => response.json())
.then(data => {
  console.log(data);
  // 保存 token 到 localStorage
  localStorage.setItem('token', data.token);
  localStorage.setItem('user', JSON.stringify({
    id: data.id,
    name: data.name,
    account: data.account
  }));
});
```

**响应示例**：
```json
{
  "id": 1,
  "name": "张三",
  "account": "zhangsan",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

## 登录 API 说明

### 接口信息

| 项目 | 内容 |
|------|------|
| **接口地址** | `POST /api/login` |
| **Content-Type** | `application/json` |
| **是否需要 Token** | 否 |

---

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account | string | 是 | 账号 |
| password | string | 是 | 密码 |

---

### 请求示例

```bash
curl -X POST http://localhost:3000/api/login \
  -H "Content-Type: application/json" \
  -d '{"account":"zhangsan","password":"123456"}'
```

**JavaScript Fetch**：
```javascript
fetch('http://localhost:3000/api/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    account: 'zhangsan',
    password: '123456'
  })
})
.then(res => res.json())
.then(data => {
  console.log(data);
  // 保存 token
  localStorage.setItem('token', data.token);
  localStorage.setItem('user', JSON.stringify({
    id: data.id,
    name: data.name,
    account: data.account
  }));
});
```

---

### 响应示例

**成功 (200)**：
```json
{
  "id": 1,
  "name": "张三",
  "account": "zhangsan",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTczODYwOTYwMCwiZXhwIjoxNzM5MjE0NDAwfQ.xxxxx"
}
```

**失败 (400)** - 参数缺失：
```json
{
  "error": "Account and password are required"
}
```

**失败 (401)** - 账号或密码错误：
```json
{
  "error": "Invalid account or password"
}
```

---

## Token 使用方法

### 封装请求工具

建议在前端项目中封装一个统一的请求工具：

```javascript
// utils/request.js
const BASE_URL = 'http://localhost:3000/api';

// 获取 token
function getToken() {
  return localStorage.getItem('token');
}

// 统一请求方法
async function request(url, options = {}) {
  const token = getToken();
  const headers = {
    'Content-Type': 'application/json',
    ...options.headers
  };
  
  // 如果有 token，添加到请求头
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  
  const response = await fetch(`${BASE_URL}${url}`, {
    ...options,
    headers
  });
  
  const data = await response.json();
  
  // 如果 token 过期或无效，跳转登录页
  if (response.status === 401) {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = '/login';
  }
  
  if (!response.ok) {
    throw new Error(data.error || '请求失败');
  }
  
  return data;
}

export default request;
```

---

## 猫咪接口（全部需要 Token）

### 获取猫咪列表

**接口**：`GET /api/cats`

```javascript
fetch('http://localhost:3000/api/cats', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
})
  .then(res => res.json())
  .then(data => console.log(data));
```

**响应示例**：
```json
[
  {
    "id": 1,
    "name": "猫咪1",
    "breed": "英短",
    "age": 3,
    "description": "一只可爱的猫咪",
    "image": "chongwu1.jpg",
    "created_at": "2026-02-04T07:33:29.000Z",
    "updated_at": "2026-02-04T07:33:29.000Z"
  }
]
```

---

### 创建猫咪（需要 Token）

**接口**：`POST /api/cats`

```javascript
const formData = new FormData();
formData.append('name', '小橘');
formData.append('breed', '橘猫');
formData.append('age', '2');
formData.append('description', '贪吃的橘猫');
formData.append('image', fileInput.files[0]); // 图片文件

fetch('http://localhost:3000/api/cats', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  },
  body: formData
})
.then(res => res.json())
.then(data => console.log(data));
```

---

### 更新猫咪（需要 Token）

**接口**：`PUT /api/cats/:id`

```javascript
const formData = new FormData();
formData.append('name', '小橘改名了');
formData.append('breed', '橘猫');
formData.append('age', '3');
formData.append('description', '更贪吃的橘猫');

fetch('http://localhost:3000/api/cats/1', {
  method: 'PUT',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  },
  body: formData
})
.then(res => res.json())
.then(data => console.log(data));
```

---

### 删除猫咪（需要 Token）

**接口**：`DELETE /api/cats/:id`

```javascript
fetch('http://localhost:3000/api/cats/1', {
  method: 'DELETE',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
})
.then(res => res.json())
.then(data => console.log(data));
```

---

## 帖子接口（全部需要 Token）

### 获取帖子列表

**接口**：`GET /api/posts`

```javascript
fetch('http://localhost:3000/api/posts', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
})
  .then(res => res.json())
  .then(data => console.log(data));
```

---

### 创建帖子（需要 Token）

**接口**：`POST /api/posts`

```javascript
const formData = new FormData();
formData.append('title', '我的猫咪');
formData.append('content', '今天带猫咪去公园了');
formData.append('image', fileInput.files[0]);

fetch('http://localhost:3000/api/posts', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  },
  body: formData
})
.then(res => res.json())
.then(data => console.log(data));
```

---

## 评论接口（全部需要 Token）

### 获取帖子评论

**接口**：`GET /api/comments/post/:post_id`

```javascript
fetch('http://localhost:3000/api/comments/post/1', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
})
  .then(res => res.json())
  .then(data => console.log(data));
```

---

### 发表评论（需要 Token）

**接口**：`POST /api/comments`

```javascript
fetch('http://localhost:3000/api/comments', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  },
  body: JSON.stringify({
    post_id: 1,
    content: '好可爱的猫咪！'
  })
})
.then(res => res.json())
.then(data => console.log(data));
```

---

## 点赞接口（全部需要 Token）

### 点赞

**接口**：`POST /api/likes`

```javascript
fetch('http://localhost:3000/api/likes', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  },
  body: JSON.stringify({
    post_id: 1
  })
})
.then(res => res.json())
.then(data => console.log(data));
```

---

### 取消点赞

**接口**：`DELETE /api/likes`

```javascript
fetch('http://localhost:3000/api/likes', {
  method: 'DELETE',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  },
  body: JSON.stringify({
    post_id: 1
  })
})
.then(res => res.json())
.then(data => console.log(data));
```

---

### 检查是否已点赞

**接口**：`GET /api/likes/check?post_id=1`

```javascript
fetch('http://localhost:3000/api/likes/check?post_id=1', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
})
.then(res => res.json())
.then(data => console.log(data));
```

---

## 图片访问

上传的图片可以通过以下方式访问：

```
http://localhost:3000/uploads/图片文件名.jpg
```

例如：`http://localhost:3000/uploads/chongwu1.jpg`

---

## 错误处理

### 常见错误码

| 状态码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权（Token 无效或过期） |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

#### 400 - 请求错误
| 场景 | 错误信息 |
|------|----------|
| 注册参数缺失 | `Name, account and password are required` |
| 账号已注册 | `Account already exists` |
| 登录参数缺失 | `Account and password are required` |
| JSON格式错误 | `Invalid JSON format` |
| 已点赞 | `Already liked` |
| 未点赞却取消 | `Not liked yet` |

#### 401 - 未授权
| 场景 | 错误信息 |
|------|----------|
| 未携带token / token无效 / token过期 | `请登录` |
| 账号或密码错误 | `Invalid account or password` |

### Token 过期处理

当收到 401 错误时，应清除本地存储的 token 并跳转登录页：

```javascript
if (response.status === 401) {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location.href = '/login';
}
```

---

## Axios 示例

如果你使用 Axios，可以这样配置：

```javascript
import axios from 'axios';

const instance = axios.create({
  baseURL: 'http://localhost:3000/api',
  timeout: 10000
});

// 请求拦截器 - 自动添加 token
instance.interceptors.request.use(
  config => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  error => Promise.reject(error)
);

// 响应拦截器 - 处理 401 错误
instance.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export default instance;
```

**使用示例**：
```javascript
import request from './utils/request';

// 登录
const login = async (email, password) => {
  const res = await request.post('/login', { email, password });
  return res.data;
};

// 获取猫咪列表
const getCats = async () => {
  const res = await request.get('/cats');
  return res.data;
};
```
